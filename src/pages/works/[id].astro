---
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";
import Breadcrumb from "../../components/Breadcrumb.astro";
import { SITE } from "../../config/site";
import Layout from "../../layouts/Layout.astro";
import { formatDate } from "../../utils/date";
import { generateBreadcrumbSchema, stringifySchema } from "../../utils/schema";

export async function getStaticPaths() {
	const works = await getCollection("works");
	return works.map((work) => ({
		params: { id: work.id },
		props: { work },
	}));
}

const { work } = Astro.props;
const { Content } = await render(work);
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const ogImageURL = new URL(work.data.coverImage.src, Astro.site);
const createdTime = work.data.startDate.toISOString();
const modifiedTime = work.data.endDate
	? work.data.endDate.toISOString()
	: createdTime;
const workSchema = {
	"@context": "https://schema.org",
	"@type": "CreativeWork",
	name: work.data.title,
	description: work.data.excerpt,
	image: ogImageURL.href,
	keywords: work.data.keywords.join(", "),
	dateCreated: createdTime,
	dateModified: modifiedTime,
	author: {
		"@type": "Person",
		name: SITE.author,
		url: Astro.site?.href,
	},
	url: canonicalURL.href,
	inLanguage: SITE.lang,
};
const breadcrumbItems = [
	{ label: "ホーム", href: "/" },
	{ label: "Works", href: "/works" },
	{ label: work.data.title },
];
const siteUrl = Astro.site?.href || SITE.url;
---

<Layout
  title={`${work.data.title} | Works | ${SITE.name}`}
  description={work.data.excerpt}
  ogType="article"
  ogImage={ogImageURL.href}
  ogImageAlt={work.data.title}
>
  <Fragment slot="head">
    <meta property="article:author" content={SITE.author} />
    <meta property="article:published_time" content={createdTime} />
    {
      work.data.endDate && (
        <meta property="article:modified_time" content={modifiedTime} />
      )
    }
    <script
      type="application/ld+json"
      set:html={stringifySchema(workSchema)}
    />
    <script
      type="application/ld+json"
      set:html={stringifySchema(generateBreadcrumbSchema(breadcrumbItems, siteUrl))}
    />
  </Fragment>
  <main class="mx-auto max-w-4xl px-6 py-12">
    <Breadcrumb items={breadcrumbItems} />
    <div class="mb-8">
      <a
        href="/works"
        class="mb-4 inline-block text-sm text-gray-600 hover:text-gray-900"
      >
        ← Works一覧へ戻る
      </a>
      <h1 class="mb-4 text-4xl font-bold">{work.data.title}</h1>
      <p class="mb-4 text-gray-600">
        {formatDate(work.data.startDate)}
        {work.data.endDate && ` - ${formatDate(work.data.endDate)}`}
      </p>
      <div class="mb-6 flex flex-wrap gap-2">
        {
          work.data.keywords.map((keyword) => (
            <span class="rounded-full bg-gray-100 px-4 py-2 text-sm">
              {keyword}
            </span>
          ))
        }
      </div>
    </div>

    <div class="mb-8 aspect-video overflow-hidden rounded-lg">
      <Image
        src={work.data.coverImage}
        alt={work.data.title}
        class="h-full w-full object-cover"
      />
    </div>

    <article class="prose prose-lg max-w-none">
      <Content />
    </article>
  </main>
</Layout>
