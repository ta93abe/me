---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import FilterSort from "../../components/FilterSort.astro";
import Badge from "../../components/ui/Badge.astro";
import Tag from "../../components/ui/Tag.astro";
import { SITE } from "../../config/site";
import Layout from "../../layouts/Layout.astro";
import { formatDate } from "../../utils/date";

const books = await getCollection("books");

const sortedBooks = [...books].sort((a, b) => {
	const aTime = a.data.finishedDate?.getTime() ?? 0;
	const bTime = b.data.finishedDate?.getTime() ?? 0;
	return bTime - aTime;
});

// すべてのタグを収集（カテゴリ + タグ）
const allTags = books.flatMap((book) => [
	...(book.data.category ? [book.data.category] : []),
	...book.data.tags,
]);

// ステータスに基づくソートオプション
const sortOptions = [
	{ value: "date-desc", label: "読了日（新しい順）" },
	{ value: "date-asc", label: "読了日（古い順）" },
	{ value: "title", label: "タイトル順" },
];
---

<Layout
  title={`Bookshelf | ${SITE.name}`}
  description="読書記録と書評の一覧。読んだ本や積読のメモをまとめています。"
>
  <main class="mx-auto max-w-6xl px-6 py-12">
    <h1 class="mb-12 text-4xl font-bold">Bookshelf</h1>

    <!-- フィルタリング・ソート -->
    <FilterSort tags={allTags} sortOptions={sortOptions} containerId="bookshelf-list" />

    <div id="bookshelf-list" class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
      {
        sortedBooks.map((book) => {
          const bookTags = [
            ...(book.data.category ? [book.data.category] : []),
            ...book.data.tags,
          ];
          return (
          <a
            href={`/bookshelf/${book.id}`}
            class="group block overflow-hidden rounded-lg border border-gray-200 transition-shadow hover:shadow-lg dark:border-gray-700"
            data-item
            data-tags={bookTags.join(",")}
            data-date={book.data.finishedDate?.toISOString() ?? ""}
            data-title={book.data.title}
          >
            <div class="aspect-[3/4] overflow-hidden bg-gray-100">
              <Image
                src={book.data.coverImage}
                alt={`${book.data.title} cover`}
                class="h-full w-full object-cover transition-transform group-hover:scale-105"
              />
            </div>
            <div class="p-4">
              <div class="mb-3 flex flex-wrap items-center gap-2">
                <Badge variant={book.data.status} />
                {book.data.category && <Tag>{book.data.category}</Tag>}
              </div>
              <h2 class="mb-1 text-xl font-bold">{book.data.title}</h2>
              <p class="mb-2 text-sm text-gray-600">{book.data.author}</p>
              {book.data.finishedDate && (
                <p class="mb-2 text-xs text-gray-500">
                  読了日: {formatDate(book.data.finishedDate)}
                </p>
              )}
              <p class="mb-3 text-sm text-gray-700">{book.data.excerpt}</p>
              <div class="flex flex-wrap gap-2">
                {book.data.tags.map((tag) => <Tag>{tag}</Tag>)}
              </div>
              {book.data.rating && (
                <p class="mt-3 text-xs text-gray-600">
                  評価: {book.data.rating} / 5
                </p>
              )}
            </div>
          </a>
        );})
      }
    </div>
  </main>
</Layout>
