---
import { Image } from "astro:assets";
import { getCollection, render } from "astro:content";
import Breadcrumb from "../../components/Breadcrumb.astro";
import Badge from "../../components/ui/Badge.astro";
import Tag from "../../components/ui/Tag.astro";
import { SITE } from "../../config/site";
import Layout from "../../layouts/Layout.astro";
import { formatDate } from "../../utils/date";
import { generateBreadcrumbSchema, stringifySchema } from "../../utils/schema";

export async function getStaticPaths() {
	const books = await getCollection("books");
	return books.map((book) => ({
		params: { id: book.id },
		props: { book },
	}));
}

const { book } = Astro.props;
const { Content } = await render(book);
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const ogImageURL = new URL(book.data.coverImage.src, Astro.site);
const tags = book.data.tags
	? Array.isArray(book.data.tags)
		? book.data.tags
		: [book.data.tags]
	: [];
const bookSchema = {
	"@context": "https://schema.org",
	"@type": "Book",
	name: book.data.title,
	author: {
		"@type": "Person",
		name: book.data.author,
	},
	description: book.data.excerpt,
	image: ogImageURL.href,
	genre: tags.join(", "),
	url: canonicalURL.href,
	inLanguage: SITE.lang,
};
const breadcrumbItems = [
	{ label: "ホーム", href: "/" },
	{ label: "Bookshelf", href: "/bookshelf" },
	{ label: book.data.title },
];
const siteUrl = Astro.site?.href || SITE.url;
---

<Layout
  title={`${book.data.title} | Bookshelf | ${SITE.name}`}
  description={book.data.excerpt}
  ogType="book"
  ogImage={ogImageURL.href}
  ogImageAlt={`${book.data.title} cover`}
>
  <Fragment slot="head">
    <meta property="book:author" content={book.data.author} />
    {tags.map((tag) => <meta property="book:tag" content={tag} />)}
    <script
      type="application/ld+json"
      set:html={stringifySchema(bookSchema)}
    />
    <script
      type="application/ld+json"
      set:html={stringifySchema(generateBreadcrumbSchema(breadcrumbItems, siteUrl))}
    />
  </Fragment>
  <main class="mx-auto max-w-4xl px-6 py-12">
    <Breadcrumb items={breadcrumbItems} />
    <div class="mb-8">
      <a
        href="/bookshelf"
        class="mb-4 inline-block text-sm text-gray-600 hover:text-gray-900"
      >
        ← Bookshelf一覧へ戻る
      </a>
      <h1 class="mb-2 text-4xl font-bold">{book.data.title}</h1>
      <p class="mb-4 text-lg text-gray-700">{book.data.author}</p>
      <div class="mb-4 flex flex-wrap items-center gap-2">
        <Badge variant={book.data.status} />
        {
          book.data.category && (
            <Tag>{book.data.category}</Tag>
          )
        }
        {
          book.data.finishedDate && (
            <span class="text-sm text-gray-600">
              読了日: {formatDate(book.data.finishedDate)}
            </span>
          )
        }
        {
          book.data.rating && (
            <span class="text-sm text-gray-600">
              評価: {book.data.rating} / 5
            </span>
          )
        }
      </div>
      <div class="flex flex-wrap gap-2">
        {tags.map((tag) => <Tag>{tag}</Tag>)}
      </div>
    </div>

    <div class="mb-8 aspect-[3/4] overflow-hidden rounded-lg">
      <Image
        src={book.data.coverImage}
        alt={`${book.data.title} cover`}
        class="h-full w-full object-cover"
      />
    </div>

    <article class="prose prose-lg max-w-none">
      <Content />
    </article>
  </main>
</Layout>
