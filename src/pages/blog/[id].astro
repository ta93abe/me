---
import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { formatDate } from "../../utils/date";
import Breadcrumb from "../../components/Breadcrumb.astro";

export async function getStaticPaths() {
	const blogPosts = await getCollection("blog");
	return blogPosts.map((post) => ({
		params: { id: post.id },
		props: { post },
	}));
}

const { post } = Astro.props;
const { Content } = await render(post);
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const publishedTime = post.data.date.toISOString();
const modifiedTime = post.data.updatedDate
	? post.data.updatedDate.toISOString()
	: publishedTime;
const ogImageURL = new URL("/og-image.png", Astro.site);
const blogSchema = {
	"@context": "https://schema.org",
	"@type": "BlogPosting",
	headline: post.data.title,
	description: post.data.excerpt,
	datePublished: publishedTime,
	dateModified: modifiedTime,
	author: {
		"@type": "Person",
		name: "Takumi Abe",
		url: Astro.site.href,
	},
	image: ogImageURL.href,
	mainEntityOfPage: canonicalURL.href,
	inLanguage: "ja",
};
---

<Layout
	title={`${post.data.title} | Blog | Portfolio`}
	description={post.data.excerpt}
	ogType="article"
	ogImage={ogImageURL.href}
	ogImageAlt={post.data.title}
>
	<Fragment slot="head">
		<meta property="article:author" content="Takumi Abe" />
		<meta property="article:published_time" content={publishedTime} />
		{post.data.updatedDate && (
			<meta property="article:modified_time" content={modifiedTime} />
		)}
		<script
			type="application/ld+json"
			set:html={JSON.stringify(blogSchema).replace(/</g, "\\u003c")}
		/>
	</Fragment>
	<main class="mx-auto max-w-4xl px-6 py-12">
		<Breadcrumb
			items={[
				{ label: "ホーム", href: "/" },
				{ label: "ブログ", href: "/blog" },
				{ label: post.data.title },
			]}
		/>
		<div class="mb-8">
			<a
				href="/blog"
				class="mb-4 inline-block text-sm text-gray-600 hover:text-gray-900"
			>
				← Blog一覧へ戻る
			</a>
			<h1 class="mb-4 text-4xl font-bold">{post.data.title}</h1>
			<time class="block text-gray-600">
				{formatDate(post.data.date)}
				{post.data.updatedDate && (
					<span class="ml-2 text-sm">
						(更新: {formatDate(post.data.updatedDate)})
					</span>
				)}
			</time>
		</div>

		<article class="prose prose-lg max-w-none">
			<Content />
		</article>
	</main>
</Layout>
