---
// ヘッダーコンポーネント
import Logo from "./Logo.astro";
import SearchModal from "./SearchModal.astro";
import ThemeToggle from "./ui/ThemeToggle.astro";

const navLinks = [
	{ href: "/works", text: "Works" },
	{ href: "/links", text: "Links" },
	{ href: "/blog", text: "Blog" },
	{ href: "/slides", text: "Slides" },
];

const currentPath = Astro.url.pathname;
---

<header
  class="sticky top-0 z-50 border-b border-gray-200 bg-white/80 backdrop-blur-sm dark:border-gray-700 dark:bg-gray-900/80"
>
  <nav
    class="mx-auto flex max-w-7xl items-center justify-between px-6 py-4"
    aria-label="メインナビゲーション"
  >
    <Logo />

    <!-- デスクトップナビゲーション -->
    <div class="hidden items-center gap-6 md:flex">
      <ul class="flex gap-6">
        {
          navLinks.map((link) => (
            <li>
              <a
                href={link.href}
                class="hover:opacity-70 dark:text-gray-200"
                aria-current={(link.href === "/" ? currentPath === "/" : currentPath.startsWith(link.href)) ? "page" : undefined}
              >
                {link.text}
              </a>
            </li>
          ))
        }
      </ul>
      <!-- 検索ボタン -->
      <button
        type="button"
        id="desktop-search-button"
        class="flex items-center gap-2 rounded-lg border border-gray-200 bg-gray-50 px-3 py-1.5 text-sm text-gray-500 transition-colors hover:border-gray-300 hover:bg-gray-100 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:border-gray-600 dark:hover:bg-gray-700"
        aria-label="サイト内検索を開く"
      >
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <span class="hidden lg:inline">検索</span>
        <kbd class="hidden rounded border border-gray-300 bg-white px-1.5 py-0.5 font-mono text-xs dark:border-gray-600 dark:bg-gray-900 lg:inline">⌘K</kbd>
      </button>
      <ThemeToggle />
    </div>

    <!-- モバイル: 検索 + テーマ切り替え + ハンバーガー -->
    <div class="flex items-center gap-2 md:hidden">
      <!-- モバイル検索ボタン -->
      <button
        type="button"
        id="mobile-search-button"
        class="flex h-10 w-10 items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"
        aria-label="サイト内検索を開く"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>
      <ThemeToggle />
      <button
        type="button"
        id="mobile-menu-button"
        class="flex h-10 w-10 items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"
        aria-label="メニューを開く"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
      <svg
        id="menu-icon-open"
        class="h-6 w-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
      <svg
        id="menu-icon-close"
        class="hidden h-6 w-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
      </button>
    </div>
  </nav>

  <!-- モバイルメニュー -->
  <div
    id="mobile-menu"
    class="hidden border-t border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-900 md:hidden"
    aria-hidden="true"
  >
    <ul class="space-y-1 px-6 py-4">
      {
        navLinks.map((link) => (
          <li>
            <a
              href={link.href}
              class="block rounded-lg px-4 py-3 text-lg hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800"
              aria-current={(link.href === "/" ? currentPath === "/" : currentPath.startsWith(link.href)) ? "page" : undefined}
            >
              {link.text}
            </a>
          </li>
        ))
      }
    </ul>
  </div>
</header>

<!-- 検索モーダル -->
<SearchModal />

<style>
  [aria-current="page"] {
    font-weight: 600;
    color: var(--primary-color);
  }
</style>

<script>
  const menuButton = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");
  const iconOpen = document.getElementById("menu-icon-open");
  const iconClose = document.getElementById("menu-icon-close");

  if (!menuButton || !mobileMenu || !iconOpen || !iconClose) {
    console.error("Mobile menu elements not found.");
  } else {
    let isOpen = false;
    const mediaQuery = window.matchMedia("(min-width: 768px)");

    function toggleMenu() {
      isOpen = !isOpen;
      mobileMenu.classList.toggle("hidden", !isOpen);
      mobileMenu.setAttribute("aria-hidden", String(!isOpen));
      menuButton.setAttribute("aria-expanded", String(isOpen));
      menuButton.setAttribute("aria-label", isOpen ? "メニューを閉じる" : "メニューを開く");
      iconOpen.classList.toggle("hidden", isOpen);
      iconClose.classList.toggle("hidden", !isOpen);
    }

    menuButton.addEventListener("click", toggleMenu);

    // Escキーでメニューを閉じる
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && isOpen) {
        toggleMenu();
        menuButton.focus();
      }
    });

    // 画面リサイズ時にメニューを閉じる (matchMediaを使用)
    window.addEventListener("resize", () => {
      if (mediaQuery.matches && isOpen) {
        toggleMenu();
      }
    });
  }

  // 検索ボタンのイベントハンドラ
  const desktopSearchBtn = document.getElementById("desktop-search-button");
  const mobileSearchBtn = document.getElementById("mobile-search-button");

  function handleSearchClick() {
    if (typeof (window as Window & { openGlobalSearch?: () => void }).openGlobalSearch === "function") {
      (window as Window & { openGlobalSearch: () => void }).openGlobalSearch();
    }
  }

  desktopSearchBtn?.addEventListener("click", handleSearchClick);
  mobileSearchBtn?.addEventListener("click", handleSearchClick);
</script>
