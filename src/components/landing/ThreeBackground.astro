---
// Three.js パーティクル背景コンポーネント
interface Props {
	class?: string;
}

const { class: className = "" } = Astro.props;
---

<div
  id="three-canvas-container"
  class:list={["three-background", className]}
  aria-hidden="true"
>
</div>

<script>
  import type { ParticleScene } from "../../scripts/three/scene";

  let scene: ParticleScene | null = null;
  let isInitialized = false;

  async function initThree() {
    // Prevent double initialization
    if (isInitialized) return;
    isInitialized = true;

    const container = document.getElementById("three-canvas-container");
    if (!container) {
      console.error(
        "Three.js container not found. Expected element with id='three-canvas-container'",
      );
      return;
    }

    try {
      // Dynamic import for better code splitting and lazy loading
      const { ParticleScene } = await import("../../scripts/three/scene");

      scene = new ParticleScene({
        container,
        particleCount: 3000,
        color: 0x1a1a1a,
      });
    } catch (error) {
      console.error("Failed to initialize Three.js scene:", error);
      // ParticleScene constructor already shows fallback UI
    }
  }

  // Lazy load Three.js after the page is interactive
  // This improves LCP and FID by not blocking the main thread during initial render
  function scheduleThreeInit() {
    // Use requestIdleCallback if available, otherwise fallback to setTimeout
    if ("requestIdleCallback" in window) {
      requestIdleCallback(() => initThree(), { timeout: 2000 });
    } else {
      // Fallback for Safari and older browsers
      setTimeout(initThree, 100);
    }
  }

  // Wait for DOM to be ready, then schedule lazy initialization
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", scheduleThreeInit);
  } else {
    scheduleThreeInit();
  }

  // Cleanup Three.js resources before page swap to prevent memory leaks
  document.addEventListener("astro:before-swap", () => {
    scene?.destroy();
    scene = null;
    isInitialized = false;
  });
</script>

<style>
  .three-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
  }

  .three-background :global(canvas) {
    display: block;
  }

  /* Fallback for reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .three-background {
      opacity: 0.3;
    }
  }
</style>
